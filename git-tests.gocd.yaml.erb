format_version: 3
pipelines:
  git-tests:
    group: go-cd
    label_template: ${COUNT}
    lock_behavior: none
    materials:
      git:
        git: https://github.com/gocd/gocd
        shallow_clone: true
        auto_update: true
        branch: master
        destination: gocd
      rpms:
        git: https://github.com/gocd/git-tests
        auto_update: true
        branch: master
        destination: git-tests
    stages:
      - test:
          fetch_materials: true
          keep_artifacts: false
          clean_workspace: false
          jobs:
            <% versions.each do |git_version| %>
            test-<%= git_version %>:
              timeout: 0
              elastic_profile_id: ecs-gocd-dev-build-highmem-centos-6
              tasks:
                - exec:
                    arguments:
                      - yum
                      - remove
                      - -y
                      - rh-git29
                    command: sudo
                    run_if: passed
                - exec:
                    arguments:
                      - rm
                      - -rf
                      - /opt/rh/rh-git29/
                    command: sudo
                    run_if: passed
                - exec:
                    arguments:
                      - rpm
                      - -i
                      - git-<%= git_version %>-x86_64.rpm
                    command: sudo
                    run_if: passed
                    working_directory: git-tests/rpms
                - exec:
                    arguments:
                      - --version
                    command: git
                    run_if: passed
                - exec:
                    command: ./gradlew
                    arguments:
                      - :domain:test
                      - :common:test
                      - --tests
                      - "*Git*Test"
                      - -PallowTestsToBeSkipped=true
                    run_if: passed
                    working_directory: gocd
<% end %>
